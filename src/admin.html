<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Santoro ProduÃ§Ã£o - Admin</title>
  <link rel="stylesheet" href="model.css">
</head>
<body>
  <header class="header-prod">
    <button id="logoutBtn" class="display:none">Sair</button>
    <h2>Admin Producao</h2>

  </header>

  <!-- Login -->
  <div id="loginContainer">
    <h2>Login Admin</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="senha" placeholder="Senha" required>
      <button type="submit">Entrar</button>
    </form>
  </div>

  <!-- CatÃ¡logo (oculto atÃ© logar) -->
  <div id="catalogoContainer" style="display:none;">
  
   

    <h3>Adicionar novo item</h3>
    <form id="addForm">
      <label for="largura">Largura</label>
      <select name="" id="largura">
        <option value="4">4</option>
        <option value="7">7</option>
        <option value="10">10</option>
      </select>
     
      <input type="number" id="aro" placeholder="Aro" min="12" max="32" required>
      <input type="number" id="qtd" placeholder="Quantidade" required>
      <button type="submit">Adicionar</button>
    </form>

    <div id="catalogo"></div>

    <div id="pedido-re">
      
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = 'https://exsnpdmbuscemohjdpus.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4c25wZG1idXNjZW1vaGpkcHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTc5OTIsImV4cCI6MjA3NTkzMzk5Mn0.kS4VsaFTYID77kEyfd8rtfrEbXlcQDMdNToFxHL4JPc'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const loginForm = document.getElementById('loginForm')
    const loginContainer = document.getElementById('loginContainer')
    const catalogoContainer = document.getElementById('catalogoContainer')
    const catalogoDiv = document.getElementById('catalogo')
    const addForm = document.getElementById('addForm')
    const logoutBtn = document.getElementById('logoutBtn')


    // ðŸ”¹ Checa se hÃ¡ sessÃ£o ativa ao carregar a pÃ¡gina
async function verificarSessao() {
  const { data, error } = await supabase.auth.getSession()
  const sessao = data?.session

  if (sessao) {
    // usuÃ¡rio jÃ¡ estÃ¡ logado
    console.log("SessÃ£o ativa:", sessao)
    loginContainer.style.display = "none"
    catalogoContainer.style.display = "block"
    logoutBtn.style.display = "block"
    carregarCatalogo()
  } else {
    // usuÃ¡rio precisa logar
    loginContainer.style.display = "block"
    catalogoContainer.style.display = "none"
    logoutBtn.style.display = "none"
  }
}

verificarSessao()


    // ðŸ”¹ Carrega a tabela de dados
    async function carregarCatalogo() {
      catalogoDiv.innerHTML = ""
      const { data, error } = await supabase.from('retasbruto').select('*').order('id', { ascending: true })
      if (error) {
        console.error(error)
        return
      }

      // Cria a tabela
      const table = document.createElement("table")
      table.border = "1"
      table.style.width = "100%"
      table.style.borderCollapse = "collapse"
      table.classList.add("table-list")

      // CabeÃ§alho
      const thead = document.createElement("thead")
      const headerRow = document.createElement("tr")
      const headers = ["Largura", "Aro", "Quantidade", "AÃ§Ãµes"]
      headers.forEach(h => {
        const th = document.createElement("th")
        th.textContent = h
        th.style.padding = "5px"
        th.style.backgroundColor = "#eee"
        headerRow.appendChild(th)
      })
      thead.appendChild(headerRow)
      table.appendChild(thead)

      // Corpo da tabela
      const tbody = document.createElement("tbody")

      data.forEach(i => {
        const row = document.createElement("tr")

        

        const tdLargura = document.createElement("td")
        tdLargura.textContent = i.largura

        const tdAro = document.createElement("td")
        tdAro.textContent = i.aro

        const tdQtd = document.createElement("td")
        tdQtd.textContent = i.qtd

        const tdAcoes = document.createElement("td")

        const btnEditar = document.createElement("button")
        btnEditar.textContent = "Editar"
        btnEditar.onclick = () => editarItem(i.id, i.qtd,i.largura)

        const btnExcluir = document.createElement("button")
        btnExcluir.textContent = "Excluir"
        btnExcluir.onclick = () => deletarItem(i.id)

        tdAcoes.append(btnEditar, btnExcluir)
        row.append(tdLargura, tdAro, tdQtd, tdAcoes)
        tbody.appendChild(row)
      })

      table.appendChild(tbody)
      catalogoDiv.appendChild(table)
    }

    // ðŸ”¹ Adicionar novo item
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault()
      const largura = document.getElementById('largura').value
      const aro = document.getElementById('aro').value
      const qtd = document.getElementById('qtd').value

      const { error } = await supabase.from('retasbruto').insert([{ largura, aro, qtd }])
      if (error) return alert(error.message)

      alert("Item adicionado!")
      addForm.reset()
      carregarCatalogo()
    })

    async function editarItem(id, qtdAtual, larguraPeca) {
      const novaQtd = prompt("Nova quantidade:", qtdAtual)
      if (novaQtd === null) return
    
      const { error } = await supabase
        .from('retasbruto')
        .update({ qtd: novaQtd })
        .eq('id', id)
    
      if (error) {
        alert("Erro ao atualizar: " + error.message)
        return
      }
    
      alert("Quantidade atualizada!")
    // ðŸ”¹ Se o novo valor for menor que 4, dispara alerta no WhatsApp
if (parseInt(novaQtd) < 4) {
  try {
    // Chama o seu endpoint Vercel
    const res = await fetch(`/api/sendMessage`)
    const data = await res.json()
    if (data.success) {
      console.log("ðŸ“© Mensagem enviada com sucesso!")
    } else {
      console.error("Erro no endpoint:", data.error)
    }
  } catch (err) {
    console.error("Erro ao enviar mensagem:", err)
  }
}

    
      carregarCatalogo()
    }
    

    // ðŸ”¹ Deletar item
    async function deletarItem(id) {
      if (!confirm("Tem certeza que deseja excluir este item?")) return
      const { error } = await supabase.from('retasbruto').delete().eq('id', id)
      if (error) return alert(error.message)

      alert("Item excluÃ­do!")
      carregarCatalogo()
    }

    // ðŸ”¹ Login
    loginForm.addEventListener('submit', async e => {
      e.preventDefault()
      const email = document.getElementById('email').value
      const senha = document.getElementById('senha').value

      const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha })
      if (error) return alert("Erro: " + error.message)

      alert('Login feito com sucesso!')
      loginContainer.style.display = "none"
      catalogoContainer.style.display = "block"
      logoutBtn.style.display = "block"
      carregarCatalogo()
    })
    if(logoutBtn)
    // ðŸ”¹ Logout
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      catalogoContainer.style.display = "none"
      loginContainer.style.display = "block"
    })

    async function carregarPedidos() {
      const container = document.getElementById("pedido-re")
      container.innerHTML = "<p>Carregando pedidos...</p>"
  
      const { data, error } = await supabase
        .from("pedidos")
        .select("*")
        .order("data_pedido", { ascending: false }) // mostra os mais recentes primeiro
  
      if (error) {
        console.error("Erro ao carregar pedidos:", error)
        container.innerHTML = "<p>Erro ao carregar pedidos.</p>"
        return
      }
  
      if (data.length === 0) {
        container.innerHTML = "<p>Nenhum pedido registrado ainda.</p>"
        return
      }
  
      // Monta o HTML dos pedidos
      const html = data.map(p => `
        <div style="padding:10px; border-bottom:1px solid #ccc" class="pedidos-list">
          <p><strong>Pedido:</strong> ${p.pedido}</p>
          <p><strong>Data:</strong> ${new Date(p.data_pedido).toLocaleString()}</p>
        </div>
      `).join("")
  
      container.innerHTML = html
    }
  
    // Chama ao carregar a pÃ¡gina
    carregarPedidos()

    
  </script>
</body>
</html>
